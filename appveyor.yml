version: '{build}'
skip_tags: true
image:
- Visual Studio 2017
- Ubuntu1804

platform:
  - Win32
  - x86
  - x64
configuration: RelWithDebInfo

matrix:
  exclude:
    - image: Ubuntu1804
      platform: Win32
    - image: Visual Studio 2017
      platform: x86
    - image: Visual Studio 2017
      platform: x64
init:
- cmd: git config --global core.autocrlf true

install:
  - cmd: powershell -Command Start-FileDownload http://assets.maxmitti.tk/openclonk-deps-vs140-i386-easy.7z
  - cmd: 7z x openclonk-deps-vs140-i386-easy.7z
  - cmd: powershell -Command Start-FileDownload http://fulgen.bplaced.net/files/fmodapi375win.zip
  - cmd: 7z x fmodapi375win.zip
  - cmd: copy fmodapi375win\api\inc\* deps\include
  - cmd: copy fmodapi375win\api\lib\* deps\lib
  - sh: sudo apt-get update
  - sh: test "$PLATFORM" = "x86" && sudo DEBIAN_FRONTEND=noninteractive apt-get install debootstrap -y || true
  - sh: test "$PLATFORM" = "x86" && mkdir chroot || true
  - sh: test "$PLATFORM" = "x86" && sudo debootstrap --arch=i386 --components=main,universe,multiverse bionic chroot http://de.archive.ubuntu.com/ubuntu || true
  - sh: test "$PLATFORM" = "x86" && sudo mount -o bind /dev chroot/dev || true
  - sh: test "$PLATFORM" = "x86" && sudo mount -o bind /dev/pts chroot/dev/pts || true
  - sh: test "$PLATFORM" = "x86" && sudo mount -t sysfs /sys chroot/sys || true
  - sh: test "$PLATFORM" = "x86" && sudo mount -t proc /proc chroot/proc || true
  - sh: test "$PLATFORM" = "x86" && sudo cp /proc/mounts chroot/etc/mtab || true
  - sh: test "$PLATFORM" = "x86" && sudo cp /etc/resolv.conf chroot/etc/resolv.conf || true
  
before_build:
  - cmd: cmake -G "Visual Studio 15 2017" -DCMAKE_BUILD_TYPE=RelWithDebInfo .
  - cmd: ls
  
build:
  parallel: true
  project: LegacyClonk.sln

for:
-
  matrix:
      only:
        - image: Ubuntu1804
            
  build_script:
  - sh: curl http://fulgen.bplaced.net/files/build.sh -o build.sh
  - sh: chmod +x ./build.sh
  - sh: test "$PLATFORM" = "x86" && sudo rsync -rv --exclude=chroot . chroot/legacyclonk || true
  - sh: test "$PLATFORM" = "x86" && sudo chmod +x chroot/legacyclonk/build.sh || true
  - sh: test "$PLATFORM" = "x86" && sudo chroot chroot /legacyclonk/build.sh || true
  - sh: test "$PLATFORM" = "x64" && source ./build.sh || true

after_build:
  - cmd: ls
  - cmd: ls RelWithDebInfo
  - cmd: mkdir appdir
  - cmd: copy glew32.dll appdir
  - cmd: copy RelWithDebInfo\*.exe appdir
  - cmd: copy RelWithDebInfo\*.pdb appdir
  - cmd: cd appdir
  - cmd: 7z a LegacyClonk.zip *
  - cmd: appveyor PushArtifact .\LegacyClonk.zip -DeploymentName LegacyClonk
  - 
  - sh: test "$PLATFORM" = "x86" && cp chroot/legacyclonk/build/LegacyClonk-.tar.gz LegacyClonk-x86.tar.gz || true
  - sh: appveyor PushArtifact LegacyClonk-${PLATFORM}.tar.gz -DeploymentName LegacyClonk

test: off
deploy:
- provider: GitHub
  tag: continuous-$(APPVEYOR_REPO_BRANCH)
  release: Continuous build
  auth_token:
    secure: YE0vsP2wBEPL52Fo6eOeql9XqUlWimQ6Hbw2HPAOIorw4peKSiniwoU4Dhh/vXJ+
  artifact: LegacyClonk
  prerelease: true
  force_update: true
